<!DOCTYPE html>
<html lang="en">
<head>
<title>My experiment</title>
    <script src="https://goal-recognition.web.app/jsPsych/jspsych.js"></script>
    <script src="https://goal-recognition.web.app/jsPsych/plugins/jspsych-instructions.js"></script>
    <script src="https://goal-recognition.web.app/jsPsych/plugins/jspsych-free-sort.js"></script>
    <script src="https://goal-recognition.web.app/jsPsych/plugins/jspsych-html-button-response.js"></script>
    <script src="https://goal-recognition.web.app/jsPsych/plugins/jspsych-survey-multi-choice.js"></script>
    <script src="https://goal-recognition.web.app/jsPsych/plugins/jspsych-survey-html-form.js"></script>
    <script src="https://goal-recognition.web.app/jsPsych/plugins/jspsych-external-html.js"></script>
    <script src="https://goal-recognition.web.app/jsPsych/plugins/jspsych-survey-text.js"></script>


    <link href="https://goal-recognition.web.app/jsPsych/css/jspsych.css" rel="stylesheet"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css" rel="stylesheet"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
</head>
<body>
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-check-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    

    <script>


      // Your web app's Firebase configuration
      var firebaseConfig = {
        apiKey: "AIzaSyDgE5nSy7lV1LQyp7VYP9lRvvYkL1FZu-8",
        authDomain: "goal-recognition.firebaseapp.com",
        databaseURL: "https://goal-recognition.firebaseio.com",
        projectId: "goal-recognition",
        storageBucket: "goal-recognition.appspot.com",
        messagingSenderId: "50275108224",
        appId: "1:50275108224:web:2d1c124110bbd8fd7c2d65"
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);

      const appCheck = firebase.appCheck();
      // Pass your reCAPTCHA v3 site key (public key) to activate(). Make sure this
      // key is the counterpart to the secret key you set in the Firebase console.

      // Get a reference to the database service
      var database = firebase.database();

      // Get a reference to the authentication service
      var auth = firebase.auth();

      var host_url = "https://goal-recognition.web.app/"      

    </script>
</body>
<script>
    appCheck.activate("6Ld8_X0fAAAAABH1i_Lbcj0wKAxXjIr70DzLxCQ2",true)

    var isMobile = false; //initiate as false
    // device detection
    if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent) 
        || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4))) { 
        isMobile = true;
    }
    

    /* create timeline */
    var pre_timeline = []
    var timeline = [];
    var turk_info = jsPsych.turk.turkInfo();
    var is_preview = turk_info.previewMode;
    var uid,worker_id,assignment_id

    var quiz_mistakes = {
        'quest1':[],
        'quest2':[],
        'quest3':[],
        'quest4':[]
    }

    const num_pictures = 20;
    const initial_delay = 5;
    const move_time = 30;
    const bonus_amount = 0.6;
    const payment_amount = 1.8;

    var slides_to_test = ['group01_slide15', 'group02_slide37', 'group03_slide45', 'group04_slide03', 'group05_slide01', 'group06_slide12', 'group07_slide24', 'group08_slide74', 'group09_slide13', 'group10_slide06', 'group11_slide28', 'group12_slide23', 'group13_slide11', 'group14_slide14', 'group15_slide39', 'group05_slide32', 'group14_slide09', 'group05_slide13', 'group06_slide09', 'group08_slide15'];
    // Define sign in callback
    auth.onAuthStateChanged(function(user){
        if (user) {
            // User is signed in, with this ID
            uid = user.uid;
            worker_id = uid;
            assignment_id = uid;

            if(!turk_info.outsideTurk){
                worker_id = turk_info.workerId;
                assignment_id = turk_info.assignmentId;
            }
            console.log('Logged in, user-id: ' + uid);
            if(!turk_info.outsideTurk && !is_preview){
                const dbRef = database.ref()
                dbRef.child("workers").child(worker_id).get().then((snapshot) => {
                    if (snapshot.exists()) {
                        //worker has alredy taken this assignment
                        disable_test("You have already completed the maximum number of HITs allowed by this requester.")
                    }else if(isMobile){
                        disable_test("Your Device is not supported for this HIT")
                    } else {
                        //worker hasn't taken this assignment yet
                        create_quiz();
                    }
                    start_survey();
                }).catch((error) => {
                        console.error(error);
                        console.error("unable to access database.");
                        disable_test("Internal server error, unable to access database.");
                        start_survey();
                });    
            }else{
                //console.error('Authentication with firebase failed!')
                //disable_test("Verification failed!\n");
                create_quiz();
                start_survey();
            }
        }
    });

    // Sign in to FireBase
    auth.signInAnonymously().catch(function(error) {
        // Handle Errors here.
        var errorCode = error.code;

        if (errorCode === 'auth/operation-not-allowed') {
            console.error('You must enable Anonymous auth in the Firebase Console.');
        } else {
            console.error(error);
            //console.error('Authentication with firebase failed!')
            //create_quiz();

            disable_test("Authentication failed!\n");
            start_survey();

        }
    });

    //create_quiz();
    //start_survey();

    function start_survey(){
        /* start the experiment */
        jsPsych.init({
            timeline: pre_timeline,
            on_finish: function(data) {
                var survey_data = JSON.parse(data.filter({"trial_type":"survey-html-form"}).select("responses").values[0]);
                
                //add data
                survey_data['AssignmentId'] = assignment_id
                survey_data['quizMistakes'] = quiz_mistakes
                if(!is_preview){
                    send_user_data(survey_data, turk_info);
                }
                //start_test()
                create_test()
                start_experiment()
    
            },
            show_progress_bar: false
        });
        
    }

    function start_test(){
        if (!turk_info.outsideTurk){
            worker_id = turk_info.workerId;
    
            // limit assighnments per worker
            if (!is_preview){
                const dbRef = database.ref()
                dbRef.child("workers").child(worker_id).get().then((snapshot) => {
                    if (snapshot.exists()) {
                        //worker has alredy taken this assignment
                        disable_test("You have already completed the maximum number of HITs allowed by this requester.")
                    } else {
                        //worker hasn't taken this assignment yet
                        create_test()
                    }
                    start_experiment()
                  }).catch((error) => {
                        console.error(error);
                  });
        
            }else{
                //
                create_test()
                start_experiment()
            }
        }else{
            create_test()
            start_experiment()
        }
    }
    
    function start_experiment(){
        /* start the experiment */
        jsPsych.init({
            timeline: timeline,
            on_finish: function(data) {
                //var survey_data = JSON.parse(data.filter({"trial_type":"survey-html-form"}).select("responses").values[0]);
                var exp_data = data.last(slides_to_test.length+1).first(slides_to_test.length).values();
                var review = JSON.parse(data.filter({"trial_type":"survey-text"}).select("responses").values[0]).Q0;
                console.log(review)
                send_trial_data(exp_data, turk_info,review);
            },
            show_progress_bar: true
        });

    }

    function disable_test(message){
        var disable = {
            type: "instructions",
            pages: ["<p>You have already completed the maximum number of HITs allowed by this requester."+
                 "Please click 'Return HIT' to avoid any impact on your approval rating.</p>"],
            show_clickable_nav: false,
            show_page_number: true
        };
        var disable = {
            type: "instructions",
            pages: ["<p>"+message+"</p>"+
                 "<p>Please click 'Return HIT' to avoid any impact on your approval rating.</p>"],
            show_clickable_nav: false,
            show_page_number: true
        };


        if(isMobile){
            disable = {
                type: "instructions",
                pages: ["<p>Your Device is not supported for this HIT</p>"],
                show_clickable_nav: false,
                show_page_number: true
            };
        }

        pre_timeline.push(disable);    
    }

    function create_quiz(){
        /* define welcome message trial */
        var welcome = {
            type: "instructions",
            pages: ["<p>In this experiment you will see " + num_pictures +
            " different pictures, one after the other</p>" +
            "<p>Each picture will contain several objects. </p>" +
            "<p>One of the objects will be flashing</p>",
            "<p>" + initial_delay + " seconds after the picture will be presented," +
            " you will be asked to move the flashing object to a position in " +
            "the picture which is most suitable place for you.</p>" +
            "<p>You will have " + move_time + " seconds to move the object." +
            " When the time will expire, you will be asked to move to the next picture.</p>" +
            "<p>Bonus will be added to the payment if all flashing objects will be moved.</p>",
            "<p>The experiment will be completed after 20 pictures.</p>"+
            "<p>Bonus of "+bonus_amount+"$ will be added to the "+payment_amount+"$ experiment's payment.</p>"+
            '<p>Please note - if you use the "back/refresh" option, the experiment will be closed,'+
            ' no payment will be given and you will Not be able to run the experiment again.</p>',
            "<p>In the next 2 pages, you will see demo of object movment.</p>"],
            show_clickable_nav: true,
            show_page_number: true
        };
        pre_timeline.push(welcome);
        //add_captcha();
        add_preview();
        if (!is_preview) {
            add_questions();
            add_form();
        }else{
            var accept = {
                type: "instructions",
                pages: ["<p>Press Accept to continue</p>"],
                show_clickable_nav: false,
                show_page_number: true
            };
            pre_timeline.push(accept);
        }
    }

    function create_test(){
        if (!is_preview) {
            for (var i = 0; i < slides_to_test.length; i++) {
                run_test(false, slides_to_test[i]);
            }    

            var goodbye = {
                type: "survey-text",
                preamble: "<p>Thank you for participating! In order to submit the Assighnment press the Continue button</p>",
                questions: [{prompt: 'If you have any comments, questions, bug report or other inputs, please insert it below', rows: 5}]
            };
            timeline.push(goodbye);

        }else{
            var accept = {
                type: "instructions",
                pages: ["<p>Click Accept to start...</p>"],
                show_clickable_nav: false,
                show_page_number: true
            };
            timeline.push(accept);
        }
    }

    function run_test(is_example, index) {
        var sort_trial = {
            type: 'free-sort',
            stim_path: host_url +"docs/svg/"+index+".svg",
            stim_id: "svg-" + index,
            prompt: "<p>Click and drag the image below to where you think it should be.</p>",
            button_label: "I'm done, take me to the next image",
            initial_delay:initial_delay,
            move_time:move_time
        };

        timeline.push(sort_trial);
    }

    function send_user_data(survey_data, turk_info){
        console.log(`worker_id:${worker_id},uid:${uid},assignment_id:${assignment_id}`)
        //create update package
        var updates = {};
        updates['/workers/' + worker_id + '/' + uid] = survey_data;

        return database.ref().update(updates, function(error) {
            if (error) {
                console.log('Failed ' + error);
            } else {
                console.log('saved user info Worker Id:' + worker_id);
            }
        });
        
        // Define sign in callback
        /*
        auth.onAuthStateChanged(function(user){
            if (user) {
                // User is signed in, with this ID
                var uid = user.uid;
                var worker_id = uid;
                var assignment_id = uid;
                
                if (!turk_info.outsideTurk){
                    // If running from Mturk, we have the worker ID and the assignment ID as well
                    worker_id = turk_info.workerId;
                    assignment_id = turk_info.assignmentId;
                }

                //add some nessary data
                survey_data['AssignmentId']=assignment_id
                survey_data['quizMistakes'] = quiz_mistakes
                //create update package
                console.log('uid: ' + uid);
                var updates = {};
                updates['/workers/' + worker_id + '/' + uid] = survey_data;

                return database.ref().update(updates, function(error) {
                    if (error) {
                      console.log('Failed ' + error);
                    } else {
                      console.log('Success! Worker Id:' + worker_id);
                      //auth.signOut();
                      //jsPsych.turk.submitToTurk(data); // Uncomment when working with AWS
                    }
                });
            }
        });

        // Sign in to FireBase
        auth.signInAnonymously().catch(function(error) {
          // Handle Errors here.
          var errorCode = error.code;

          if (errorCode === 'auth/operation-not-allowed') {
            alert('You must enable Anonymous auth in the Firebase Console.');
          } else {
            console.error(error);
          }
        });
        */
    }

    function send_trial_data(data, turk_info,review="") {
        var slides_post_data = {};
        var data_array = data;
        var stim_ids = [];
        for (let i = 0; i < data_array.length; i++) {
            let trial_data = data_array[i];
            delete trial_data['internal_node_id'];
            delete trial_data['trial_index'];
            delete trial_data['trial_type'];

            slides_post_data[trial_data["stim_id"]] = trial_data;
            stim_ids.push(trial_data["stim_id"])
        }


        var updates = {};

        //add some nessesery data
        //survey_data['AssignmentId']=assignment_id
        //survey_data['quizMistakes'] = quiz_mistakes
        //survey_data['hit'] = slides_post_data

        updates['/workers/' + worker_id + '/' + uid + '/hit'] = slides_post_data;
        updates['/workers/' + worker_id + '/' + uid + '/review'] = review;
        for (let i = 0; i < stim_ids.length; i++) {
            slides_post_data[stim_ids[i]]['AssignmentId']=assignment_id
            updates['/slides/' + stim_ids[i] + '/' + worker_id + '/' + uid] =slides_post_data[stim_ids[i]];
        }

        return database.ref().update(updates, function(error) {
            if (error) {
              console.log('Failed ' + error);
            } else {
              console.log('Success! Worker Id:' + worker_id);
              auth.signOut();
              jsPsych.turk.submitToTurk(data); // Uncomment when working with AWS
            }
        });

        /*
        // Define sign in callback
        auth.onAuthStateChanged(function(user){
            if (user) {
                // User is signed in, with this ID
                var uid = user.uid;
                var worker_id = uid;
                var assignment_id = uid;

                console.log(worker_id)
                
                if (!turk_info.outsideTurk){
                    // If running from Mturk, we have the worker ID and the assignment ID as well
                    worker_id = turk_info.workerId;
                    assignment_id = turk_info.assignmentId;
                }

                //remove unnessary data
                for (let i = 0; i < stim_ids.length; i++) {
                    delete slides_post_data[stim_ids[i]]['internal_node_id'];
                    delete slides_post_data[stim_ids[i]]['trial_index'];
                    delete slides_post_data[stim_ids[i]]['trial_type'];
                }


                //create update package
                console.log('uid: ' + uid);
                var updates = {};

                //add some nessary data
                
                //survey_data['AssignmentId']=assignment_id
                //survey_data['hit'] = slides_post_data
                //survey_data['quizMistakes'] = quiz_mistakes
                
                //updates['/workers/' + worker_id + '/' + uid] = survey_data;
                
                for (let i = 0; i < stim_ids.length; i++) {
                    slides_post_data[stim_ids[i]]['AssignmentId']=assignment_id
                    updates['/slides/' + stim_ids[i] + '/' + worker_id + '/' + uid] =slides_post_data[stim_ids[i]];
                }

                return database.ref().update(updates, function(error) {
                    if (error) {
                      console.log('Failed ' + error);
                    } else {
                      console.log('Success! Worker Id:' + worker_id);
                      auth.signOut();
                      jsPsych.turk.submitToTurk(data); // Uncomment when working with AWS
                    }
                });
            }
        });

        // Sign in to FireBase
        auth.signInAnonymously().catch(function(error) {
          // Handle Errors here.
          var errorCode = error.code;

          if (errorCode === 'auth/operation-not-allowed') {
            alert('You must enable Anonymous auth in the Firebase Console.');
          } else {
            console.error(error);
          }
        });*/
    }

    function add_captcha(){
        // reCAPTCHA object
        var recaptcha = {
            type: "external-html",
            url: host_url +"docs/recaptcha.html",
            cont_btn: "submit_button",
            execute_script: true,
            on_submit_form:function(event) {
                console.log(event)
            }
        };
        pre_timeline.push(recaptcha);
    }

    function add_questions() {
        var quest1 = {
            type: 'html-button-response',
            stimulus: '<p>1. How Many pictures will be in the experiment?</p>',
            choices: [num_pictures, num_pictures-2, 1, num_pictures + 5],
            prompt: "<p>Choose the correct answer</p>"
            };
        var loop1 = {
            timeline: [quest1],
            loop_function: function (data) {
                if (data.values()[0].button_pressed !== "0"){
                    alert('Wrong answer, please try again.');
                    quiz_mistakes['quest1'].push(data.values()[0].button_pressed)
                    return true;
                } else {
                    return false;
                }
            }
        };

        var quest2 = {
            type: 'html-button-response',
            stimulus: '<p>2. For each picture, which object should be moved?</p>',
            choices: ['The non-flashing objects in the picture',
                'All objects in the picture',
                'The flashing object in the picture'],
            prompt: "<p>Choose the correct answer</p>"
            };
        var loop2 = {
            timeline: [quest2],
            loop_function: function (data) {
                if (data.values()[0].button_pressed !== "2"){
                    alert('Wrong answer, please try again.');
                    quiz_mistakes['quest2'].push(data.values()[0].button_pressed)
                    return true;
                } else {
                    return false;
                }
            }
        };

        var quest3 = {
            type: 'html-button-response',
            stimulus: '<p>3. How much time will the object flash before you will be able to move it?</p>',
            choices: [`${initial_delay} Seconds`, `0 Seconds`, `${initial_delay + 7} Seconds`],
            prompt: "<p>Choose the correct answer</p>"
            };
        var loop3 = {
            timeline: [quest3],
            loop_function: function (data) {
                if (data.values()[0].button_pressed !== "0"){
                    alert('Wrong answer, please try again.');
                    quiz_mistakes['quest3'].push(data.values()[0].button_pressed)
                    return true;
                } else {
                    return false;
                }
            }
        };

        var quest4 = {
            type: 'html-button-response',
            stimulus: '<p>4. When will you get bonus?</p>',
            choices: ['If the flashing object in one of the pictures will not be moved',
                'If for all pictures, the flashing object will not be moved before moving to next picture',
                'If for all pictures, the flashing object will be moved before moving to next picture'],
            prompt: "<p>Choose the correct answer</p>"
            };
        var loop4 = {
            timeline: [quest4],
            loop_function: function (data) {
                if (data.values()[0].button_pressed !== "2"){
                    alert('Wrong answer, please try again.');
                    quiz_mistakes['quest4'].push(data.values()[0].button_pressed)
                    return true;
                } else {
                    return false;
                }
            }
        };

        pre_timeline.push(loop1);
        pre_timeline.push(loop2);
        pre_timeline.push(loop3);
        pre_timeline.push(loop4);
    }

    function add_preview(){
        var preview1 = {
            type: 'free-sort',
            stim_path: host_url +"docs/preview_slide1.svg",
            stim_id: "preview_1",
            prompt: "<p>Preview:</p>",
            button_label: "next",
            initial_delay:8,
            move_time:0,
            auto_continue:true
        };
        var preview2 = {
            type: 'free-sort',
            stim_path: host_url +"docs/preview_slide2.svg",
            stim_id: "preview_2",
            prompt: "<p>Preview:</p>",
            button_label: "next",
            initial_delay:10,
            move_time:0,
            auto_continue:true
        };
        pre_timeline.push(preview1);
        pre_timeline.push(preview2);
    }

    function add_form(){
          var trial = {
            type: "survey-html-form",
            preamble: '<p>answer these questions:</p>',
            html: '<p>'+
                'Age:<input name="age" type="number" required/></br><br/>'+
                'Gender:<select name="gender" id="gender" required>'+
                    '<option disabled selected value> -- select an option -- </option>'+
                    '<option value="male">Male</option>'+
                    '<option value="female">Female</option>'+
                    '<option value="other">Other</option>'+
                '</select><br/><br/>'+
                'Strong Hand:<select name="hand" id="hand" required>'+
                    '<option disabled selected value> -- select an option -- </option>'+
                    '<option value="left">Left</option>'+
                    '<option value="right">Right</option>'+
                    '<option value="other">Other</option>'+
                '</select><br/><br/>',
          };
          pre_timeline.push(trial);
    }
</script>
</html>